@page "/login"
@using Fylum.Client.Auth
@using Fylum.Client.Auth.Token
@using Fylum.Users.Api.Shared
@using MudBlazor
@inject ITokenService TokenService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudCard Class="mx-auto mt-5">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Login</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudForm @bind-IsValid="@_success">
            <MudTextField T="string" Label="Username" Required="true"
                          @bind-Value="_username"
                          Immediate="true" />

            <MudTextField T="string" Label="Password" Required="true"
                          InputType="InputType.Password"
                          @bind-Value="_password"
                          Immediate="true" />
        </MudForm>
    </MudCardContent>
    <MudCardActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                   Disabled="@(!_success || _loading)" 
                   OnClick="OnLoginAsync">
            @if (_loading)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">Loading...</MudText>
            }
            else
            {
                <MudText>Login</MudText>
            }
        </MudButton>
    </MudCardActions>
</MudCard>

@code {
    private string _username = "";
    private string _password = "";
    private bool _success;
    private bool _loading;

    private async Task OnLoginAsync()
    {
        _loading = true;
        try
        {
            // Der AuthClient speichert die Tokens automatisch im ITokenStorage
            await TokenService.LoginAsync(_username, _password);
            
            Snackbar.Add("Login successful!", Severity.Success);
            Navigation.NavigateTo("/folders");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Login failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
}